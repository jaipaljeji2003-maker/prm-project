<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PRM Lead</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="topbar">
    <button onclick="load(true)">Refresh</button>
    <button onclick="logout()">Logout</button>

    <div class="filters" id="zoneControls" style="flex: 1;">
      <button class="pill active" id="zTB" onclick="setZone('TB')">TB</button>
      <button class="pill" id="zGates" onclick="setZone('Gates')">Gates</button>
      <button class="pill" id="zPierA" onclick="setZone('Pier A')">Pier A</button>
      <button class="pill" id="zT1" onclick="setZone('T1')">T1</button>
      <button class="pill" id="zUnassigned" onclick="setZone('Unassigned')">Unassigned</button>
      <select id="zoneSel" onchange="onZoneDropdownChange()"></select>
    </div>

    <div class="filters">
      <button class="pill active" id="tALL" onclick="setType('ALL')">All</button>
      <button class="pill" id="tARR" onclick="setType('ARR')">ARR</button>
      <button class="pill" id="tDEP" onclick="setType('DEP')">DEP</button>
    </div>

    <div class="searchWrap">
      <input id="q" placeholder="Search flight (ex: AC123, TS 101)..." oninput="onSearchInput()" />
      <div class="hint">Search matches Flight (spaces ignored). Auto-refresh pauses while typing.</div>
    </div>
  </div>

  <div class="hint">Edits: Assignment, Pax. Ack clears alerts instantly (does NOT remove flight).</div>
  <div id="err" class="err"></div>
  <div id="loading" class="loading" style="display:none;">Loadingâ€¦</div>

  <table id="tbl">
    <thead>
      <tr>
        <th>Flight</th><th>Type</th><th>Time</th><th>Gate</th><th>Zone</th>
        <th>WCHR</th><th>WCHC</th><th>Alert</th>
        <th>Assignment</th><th>Pax</th><th>Ack</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="/config.js"></script>
  <script>
    const API_BASE = (window.PRM_CONFIG && window.PRM_CONFIG.API_BASE) || "";
    const LS_TOKEN = "PRM_TOKEN";
    const LS_USER  = "PRM_USER";

    function getToken(){ return localStorage.getItem(LS_TOKEN) || ""; }
    function hardRedirectToLogin(){ window.location.href = "/"; }

    function logout(){
      localStorage.removeItem(LS_TOKEN);
      localStorage.removeItem(LS_USER);
      hardRedirectToLogin();
    }

    async function validateAuthThenInit(){
      const token = getToken();
      if (!token) return hardRedirectToLogin();

      try {
        const res = await fetch(API_BASE + "/auth/validate?app=lead", {
          headers: { "authorization": "Bearer " + token }
        });
        const data = await res.json();
        if (!data || !data.ok) {
          localStorage.removeItem(LS_TOKEN);
          localStorage.removeItem(LS_USER);
          return hardRedirectToLogin();
        }
        await init();
        setInterval(() => load(false), 30000);
      } catch {
        localStorage.removeItem(LS_TOKEN);
        localStorage.removeItem(LS_USER);
        hardRedirectToLogin();
      }
    }

    let rows = [];
    let zonesAll = [];
    let filterType = "ALL";
    let selectedZone = "TB";

    let typingUntil = 0;
    const saveTimers = new Map();

    const CACHE_MS = 30000;
    const cache = new Map();

    const ackSuppress = new Map();
    const ACK_SUPPRESS_MS = 8000;

    let requestSeq = 0;

    const urlParams = new URLSearchParams(window.location.search);
    const zoneParam = urlParams.get("zone");
    const lockZone = (urlParams.get("lockZone") === "1");
    if (zoneParam) selectedZone = zoneParam;

    if (lockZone) {
      const zc = document.getElementById("zoneControls");
      if (zc) zc.classList.add("hidden");
    }

    function setErr(msg) { document.getElementById("err").textContent = msg || ""; }
    function setLoading(on) { document.getElementById("loading").style.display = on ? "block" : "none"; }

    function fmtTimeOnly(dt) {
      if (!dt) return "";
      const d = new Date(dt);
      if (isNaN(d.getTime())) return String(dt);
      return d.toLocaleTimeString(undefined, { hour:"2-digit", minute:"2-digit", hour12:false });
    }

    function normalizeFlightQ(s) { return String(s || "").toUpperCase().replace(/\s+/g, ""); }

    function isTyping() {
      const tag = (document.activeElement && document.activeElement.tagName) || "";
      return Date.now() < typingUntil || tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT";
    }

    function onSearchInput() { typingUntil = Date.now() + 1200; render(); }

    function setType(t) {
      filterType = t;
      document.getElementById("tALL").classList.toggle("active", t === "ALL");
      document.getElementById("tARR").classList.toggle("active", t === "ARR");
      document.getElementById("tDEP").classList.toggle("active", t === "DEP");
      useCacheThenFetch_();
    }

    function setZone(z) { selectedZone = z; syncZonePills_(); syncZoneDropdown_(); useCacheThenFetch_(); }

    function onZoneDropdownChange() {
      const z = document.getElementById("zoneSel").value;
      if (!z) return;
      selectedZone = z;
      syncZonePills_();
      useCacheThenFetch_();
    }

    function syncZonePills_() {
      const map = { "TB":"zTB", "Gates":"zGates", "Pier A":"zPierA", "T1":"zT1", "Unassigned":"zUnassigned" };
      Object.keys(map).forEach(k => {
        const el = document.getElementById(map[k]);
        if (el) el.classList.toggle("active", selectedZone === k);
      });
    }
    function syncZoneDropdown_() {
      const sel = document.getElementById("zoneSel");
      if (sel && sel.value !== selectedZone) sel.value = selectedZone;
    }

    function cacheKey_(){ return `${selectedZone}__${filterType}`; }

    function applyAckSuppression_(arr) {
      const now = Date.now();
      return (arr || []).map(r => {
        const key = String(r.key || "");
        const exp = ackSuppress.get(key);
        if (!exp) return r;
        if (now > exp) { ackSuppress.delete(key); return r; }
        return { ...r, alert:"", gateChanged:false, timeChanged:false, zoneChanged:false };
      });
    }

    function useCacheThenFetch_() {
      const key = cacheKey_();
      const hit = cache.get(key);
      if (hit && (Date.now() - hit.ts) <= CACHE_MS) {
        rows = applyAckSuppression_(hit.rows);
        render();
        load(false);
      } else load(true);
    }

    async function init() {
      const token = getToken();
      if (!token) return hardRedirectToLogin();

      setErr("");
      try {
        const res = await fetch(API_BASE + "/lead/init", {
          headers: { "authorization": "Bearer " + token }
        });
        const data = await res.json();
        zonesAll = (data && data.zones) ? data.zones : ["TB","Gates","Pier A","T1","Unassigned"];

        const sel = document.getElementById("zoneSel");
        sel.innerHTML = zonesAll.map(z => `<option value="${escapeAttr(z)}">${escapeHtml(z)}</option>`).join("");

        if (!zonesAll.includes(selectedZone)) selectedZone = zonesAll[0] || "TB";
        syncZonePills_();
        syncZoneDropdown_();

        await load(true);
      } catch (e) {
        setErr(e && e.message ? e.message : String(e));
      }
    }

    async function load(force=false) {
      if (!force && isTyping()) return;

      const token = getToken();
      if (!token) return hardRedirectToLogin();

      const myReq = ++requestSeq;
      setErr("");
      setLoading(true);

      const zone = selectedZone;
      const type = filterType;

      try {
        const url = new URL(API_BASE + "/lead/rows");
        url.searchParams.set("zone", zone);
        url.searchParams.set("type", type);
        url.searchParams.set("q", document.getElementById("q").value || "");

        const res = await fetch(url.toString(), {
          headers: { "authorization": "Bearer " + token }
        });
        const data = await res.json();
        if (myReq !== requestSeq) return;

        if (!data || !data.ok) {
          const msg = (data && data.error) || "Fetch failed";
          if (/unauthorized|expired|missing token/i.test(msg)) return hardRedirectToLogin();
          setErr(msg);
          setLoading(false);
          return;
        }

        const incoming = data.rows || [];
        const cleaned = applyAckSuppression_(incoming);
        rows = cleaned;
        cache.set(cacheKey_(), { ts: Date.now(), rows: incoming });
        render();
        setLoading(false);

      } catch (e) {
        if (myReq !== requestSeq) return;
        const msg = (e && e.message) ? e.message : String(e);
        if (/unauthorized|expired|missing token/i.test(msg)) return hardRedirectToLogin();
        setErr(msg);
        setLoading(false);
      }
    }

    function render() {
      const tb = document.querySelector("#tbl tbody");
      tb.innerHTML = "";

      const q = normalizeFlightQ(document.getElementById("q").value);

      const filtered = rows.filter(r => {
        const ftOk = (filterType === "ALL") || (String(r.type || "").toUpperCase() === filterType);
        const qOk  = !q || normalizeFlightQ(r.flight).includes(q);
        return ftOk && qOk;
      });

      filtered.forEach(r => {
        const tr = document.createElement("tr");

        const t = String(r.type || "").toUpperCase();
        const typeClass = (t === "ARR") ? "type-arr" : (t === "DEP") ? "type-dep" : "";
        const gateClass = r.gateChanged ? "cell-gatechg" : "";
        const timeClass = r.timeChanged ? "cell-timechg" : "";

        tr.innerHTML = `
          <td><div><b>${escapeHtml(r.flight || "")}</b></div><div class="small">${escapeHtml(r.key || "")}</div></td>
          <td class="${typeClass}">${escapeHtml(r.type || "")}</td>
          <td class="${timeClass}">${escapeHtml(fmtTimeOnly(r.timeEst))}</td>
          <td class="${gateClass}">${escapeHtml(r.gate || "")}</td>
          <td>${escapeHtml(r.zone || "")}</td>
          <td>${escapeHtml(r.wchr || "")}</td>
          <td>${escapeHtml(r.wchc || "")}</td>
          <td class="alert">${escapeHtml(r.alert || "")}</td>
          <td><input data-key="${escapeAttr(r.key)}" data-field="assignment" value="${escapeAttr(r.assignment || "")}" /></td>
          <td><input data-key="${escapeAttr(r.key)}" data-field="pax" value="${escapeAttr(r.pax || "")}" /></td>
          <td><button onclick="ack('${escapeAttr(r.key)}')">Ack</button></td>
        `;

        tb.appendChild(tr);
      });

      tb.querySelectorAll("input").forEach(el => {
        el.addEventListener("input", onFieldInput);
        el.addEventListener("blur", onFieldBlur);
      });
    }

    function onFieldInput(e) {
      typingUntil = Date.now() + 1200;

      const el = e.target;
      const key = el.getAttribute("data-key");
      const field = el.getAttribute("data-field");
      const val = el.value;
      if (!key || !field) return;

      const timerKey = `${key}__${field}`;
      if (saveTimers.has(timerKey)) clearTimeout(saveTimers.get(timerKey));

      saveTimers.set(timerKey, setTimeout(() => {
        saveTimers.delete(timerKey);
        saveField(key, field, val);
      }, 700));
    }

    function onFieldBlur(e) {
      const el = e.target;
      const key = el.getAttribute("data-key");
      const field = el.getAttribute("data-field");
      const val = el.value;
      if (!key || !field) return;
      saveField(key, field, val);
    }

    async function saveField(key, field, val) {
      const token = getToken();
      if (!token) return hardRedirectToLogin();

      setErr("");
      const payload = { key };
      payload[field] = val;

      try {
        const res = await fetch(API_BASE + "/lead/update", {
          method: "PATCH",
          headers: {
            "content-type": "application/json",
            "authorization": "Bearer " + token
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!data || !data.ok) setErr((data && data.error) || "Update failed");
      } catch (e) {
        setErr(e && e.message ? e.message : String(e));
      }
    }

    async function ack(key) {
      if (!key) return;

      const token = getToken();
      if (!token) return hardRedirectToLogin();

      setErr("");

      ackSuppress.set(String(key), Date.now() + ACK_SUPPRESS_MS);
      cache.delete(cacheKey_());

      rows = rows.map(r => (String(r.key) !== String(key)) ? r : ({ ...r, alert:"", gateChanged:false, timeChanged:false, zoneChanged:false }));
      render();

      try {
        const res = await fetch(API_BASE + "/lead/ack", {
          method: "POST",
          headers: {
            "content-type": "application/json",
            "authorization": "Bearer " + token
          },
          body: JSON.stringify({ key, zone: selectedZone })
        });
        const data = await res.json();
        if (!data || !data.ok) setErr((data && data.error) || "ACK failed");
        await load(true);
      } catch (e) {
        setErr((e && e.message) ? e.message : String(e));
        await load(true);
      }
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function escapeAttr(s) { return escapeHtml(s).replaceAll("\n", " "); }

    validateAuthThenInit();
  </script>
</body>
</html>
